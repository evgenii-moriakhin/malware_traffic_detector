import asyncio
import threading
import tkinter as tk
import datetime
from tkinter import ttk

import aiohttp


class SnifferUI:
    def __init__(self, traffic_sniffer):
        self.traffic_sniffer = traffic_sniffer
        self.capture_thread = None
        self.root = tk.Tk()
        self.root.title("Traffic Sniffer")
        self.create_widgets()

    def start_capture(self):
        if self.capture_thread and self.capture_thread.is_alive():
            return

        self.capture_thread = threading.Thread(target=self.run_capture)
        self.capture_thread.start()
        self.start_button.config(state=tk.DISABLED)  # Disable the button after starting capture
        self.write_log("Capture STARTED. Start button now is inactive")

    def run_capture(self):
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        loop.run_until_complete(self.traffic_sniffer.start_capture())

    @property
    def current_time(self):
        return datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    def display_packets(self):
        self.root.after(5000, self.display_packets)  # Schedule the next update

        if not self.traffic_sniffer.capture_paused:
            buffer = self.traffic_sniffer.get_buffer()
            self.write_log(f"Captured {len(buffer)} packets")

    async def send_data_async(self):
        buffer = self.traffic_sniffer.export_data()

        url = self.server_url.get()

        if not url:
            self.write_log("Please provide a server URL.")
            buffer.real_close()
            return

        headers = {"Content-Type": "application/octet-stream"}
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(url, data=buffer, headers=headers) as response:
                    if response.status == 200:
                        self.write_log(f"Data sent to {url}")
                        self.write_log(f"Response from server - {await response.read()}")
                    else:
                        self.write_log(f"Error sending data to {url}: {response.status}")
        except Exception as e:
            self.write_log(f"Error sending data to {url}: {repr(e)}\n")

        buffer.real_close()
        self.traffic_sniffer.clear_buffer()

    def send_data(self):
        asyncio.run(self.send_data_async())

    def write_log(self, msg):
        self.packet_logger.insert(tk.END, f"{self.current_time} - {msg}\n")
        self.packet_logger.see(tk.END)

    def pause_capture(self):
        self.traffic_sniffer.pause_capture()
        self.write_log(f"Capture PAUSED")

    def resume_capture(self):
        self.traffic_sniffer.resume_capture()
        self.write_log(f"Capture RESUMED")

    def clear_buffer(self):
        self.traffic_sniffer.clear_buffer()
        self.write_log(f"Buffer CLEARED")

    def save_buffer(self):
        file_name = "buffer_output.pcap"
        self.traffic_sniffer.save_buffer(file_name)
        self.write_log(f"Buffer SAVED to {file_name}")

    def create_widgets(self):
        frame = ttk.Frame(self.root, padding="10")
        frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        self.start_button = ttk.Button(frame, text="Start Capture", command=self.start_capture)
        self.start_button.grid(row=0, column=0, padx=(0, 10), pady=(0, 10), sticky=tk.W)

        self.export_button = ttk.Button(frame, text="Send Data", command=self.send_data)
        self.export_button.grid(row=0, column=1, pady=(0, 10), sticky=tk.W)

        self.pause_button = ttk.Button(frame, text="Pause Capture", command=self.pause_capture)
        self.pause_button.grid(row=0, column=2, padx=(0, 10), pady=(0, 10), sticky=tk.W)

        self.resume_button = ttk.Button(frame, text="Resume Capture", command=self.resume_capture)
        self.resume_button.grid(row=0, column=3, pady=(0, 10), sticky=tk.W)

        self.clear_button = ttk.Button(frame, text="Clear Buffer", command=self.clear_buffer)
        self.clear_button.grid(row=0, column=4, padx=(0, 10), pady=(0, 10), sticky=tk.W)

        self.save_button = ttk.Button(frame, text="Save Buffer", command=self.save_buffer)
        self.save_button.grid(row=0, column=5, pady=(0, 10), sticky=tk.W)

        self.packet_logger = tk.Text(frame, wrap=tk.WORD, height=10, width=60)
        self.packet_logger.grid(row=1, column=0, columnspan=4, pady=(0, 10), sticky=(tk.W, tk.E, tk.N, tk.S))

        scrollbar = ttk.Scrollbar(frame, orient=tk.VERTICAL, command=self.packet_logger.yview)
        scrollbar.grid(row=1, column=4, pady=(0, 10), sticky=(tk.N, tk.S))
        self.packet_logger["yscrollcommand"] = scrollbar.set

        ttk.Label(frame, text="Server URL:").grid(row=2, column=0, sticky=tk.W, pady=(10, 0))
        self.server_url = ttk.Entry(frame)
        self.server_url.grid(row=2, column=1, columnspan=3, pady=(10, 0), sticky=(tk.W, tk.E))

    def run(self):
        self.display_packets()
        self.root.mainloop()
