from io import BytesIO

from scapy.all import AsyncSniffer
from scapy.utils import wrpcap


class CustomBytesIO(BytesIO):
    def close(self) -> None:
        # avoiding auto close with scapy.utils.wrpcap
        ...

    def real_close(self):
        super().close()


class TrafficSniffer:
    def __init__(self, filter_criteria):
        self.buffer = []
        self.sniffer = None
        self.capture_paused = True
        self.filter_criteria = filter_criteria

    async def start_capture(self):
        def packet_handler(pkt):
            if not self.capture_paused and self.filter_criteria(pkt):
                self.buffer.append(pkt)

        self.resume_capture()
        self.sniffer = AsyncSniffer(prn=packet_handler)
        self.sniffer.start()

    def stop_capture(self):
        if self.sniffer:
            self.sniffer.stop()
            self.sniffer.join()

    def pause_capture(self):
        self.capture_paused = True

    def resume_capture(self):
        self.capture_paused = False

    def get_buffer(self):
        return self.buffer

    def export_data(self) -> CustomBytesIO:
        bytes_io_buffer = CustomBytesIO()
        wrpcap(bytes_io_buffer, self.buffer)
        bytes_io_buffer.seek(0)
        return bytes_io_buffer

    def clear_buffer(self):
        self.buffer.clear()

    def save_buffer(self, file_name):
        with open(file_name, "wb") as f:
            f.write(self.export_data().getvalue())
